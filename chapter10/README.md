# 10. 链接和实例化

本章主要对虚拟机进行以下两项改进
- 通过良好定义的接口向外部暴露虚拟机的核心状态，即执行中模块的核心要素（函数、表、内存和全局变量），让外部可以访问
- 实现模块链接，让函数、表、内存和全局变量可以在模块实例间共享

## 定义示例接口

### 1. 模块格式
- 4 种表现形式
  - 文本：相当于汇编语言，可以由编译器编译成二进制
  - 二进制：精确描述模块的整体结构和各种细节信息，与 wasm 实现无关
  - 内存表示：模块加载到内存之后的表现，与 wasm 实现相关
  - 模块实例：承载模块运行期间的各种状态

### 2. 语义阶段
1. 解码：将二进制模块解码为内存表示
2. 验证：对模块进行严格的验证
3. 执行
    1. 实例化：根据模块内存创建并准备好模块实例
    2. 调用：调用模块的公开函数

### 3. 模块成员
- 关键成员：函数、表、内存、全局变量
- 二进制模块在导入和导出段描述如何导入和导出以上关键成员，根据描述信息可将多个模块实例链接起来，共享成员，完成复杂任务
- 模块的参考接口定义

    ```bash
    type WasmVal = interface{}

    type Module interface {
      // GetMember 是必须项，其余均为基于 GetMember 的拓展项
      GetMember(name string) interface{}

      InvokeFunc(name string, args ...WasmVal) ([]WasmVal, error)
      GetGlobalVal(name string) (WasmVal, error)
      SetGlobalVal(name string, value WasmVal) error
    }

    // 函数、表、内存、全局变量的接口定义参考随书代码
    ```

## 实现实例接口
- 改造已有结构实现上一节定义的接口即可

## 实例化模块
1. 链接导入的项目
2. 分配并初始化内部定义的项目
3. 执行起始函数
