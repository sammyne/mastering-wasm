# 08. 控制指令

控制指令共 13 条，分布如下
- 3 条结构化控制指令
- 4 条跳转指令
- 2 条函数调用指令
- 2 条伪指令
- 2 条其他指令

## 介绍
- wasm 抛弃了任意跳转指令 `goto`/`jump`，只支持结构化控制指令和受限制的跳转指令
- wasm 提供了 3 条控制指令 `block`、`loop` 和 `if` 分别对应基本的 3 种控制结构--**顺序**、**循环**和**分支**。控制指令必须和 `end` 伪指令成对出现，具有良好的结构特征，因此被称为**结构化控制指令**

### 跳转标签
- wasm 只支持受限的跳转指令
- 这些跳转指令只能跳转到结构化控制指令所定义的目标处--**跳转标签**
- 对于 `block` 和 `if` 指令，跳转目标位于指令结尾处；对于 `loop` 指令，跳转目标位于指令开始处
- `loop` 指令不能自动形成循环，必须和跳转指令配合使用
- 跳转指令有**两个限制**
  - 不能跳出函数
  - 只能跳出外围控制块，不能跳到平行的控制块里

### 跳转标签索引
- 跳转标签是相对的，是一个抽象概念，只有针对具体跳转指令才有具体含义
- 标签索引 0 表示该指令所在控制块定义的跳转标签，1 表示往外一层控制块定义的跳转标签，2 表示再往外一层控制块定义的跳转标签，依此类推
- 函数的结尾有一个隐式标签，从任意位置都可以跳到这里，导致函数返回。支持这个跳转的是 `return` 指令
- 为了便于程序猿读写，WAT 允许给标签分配标识符，从而在跳转指令通过标签名字来指定跳转目标
- 跳转指令共 4 条
  指令 | 操作码 | 说明
  ----|-------|------
  br | 0x0C | 无条件跳转
  br_if | 0x0D | 条件跳转
  br_table | 0x0E | 查表跳转
  return | 0x0F | 直接跳出最外层循环（导致函数返回）

### 块类型
- 结构化控制指令就像一个内联函数，其类型称为结构化控制指令的**块类型**

## 实现
### block 和 loop 指令
- 理解结构化控制指令最简单的方式是把它想象成内联函数调用
  - 指令的块类型相当于函数签名
  - 指令的内部指令相当于函数字节码
  - 进入结构化控制指令时，参数已经在栈顶
  - 指令结束时，参数的位置被结果取代
- 函数的参数理论上说并不在栈上，要通过专门的局部变量指令来操作。而控制指令的参数就在栈上，无法通过局部变量指令来操作
- `block` 和 `loop` 指令的伪代码
  ```
  label: {
    // 参数应该在栈顶
    // ... 执行
    // 参数被结果取代
  }
  ```

### if 指令
- 指令执行时，会先从操作数栈弹出一个布尔值（`i32` 类型）。如果该值为真（非零）就执行第一个内联函数，否则执行第二个内联函数
- 伪代码如下
  ```
  label: {
    cond = pop()
    // 参数应该在栈顶
    if cond != 0 {
      // ... 执行分支 1
    } else {
      // ... 执行分支 2
    }
    // 参数被结果取代
  }
  ```

### br 指令
- `br` 指令进行无条件跳转，该指令带有一个立即数，指定跳转的目标标签索引
- 根据目标标签索引，可以定位到一个控制块，`br` 指令导致这个控制块提前结束（如果是 `block` 或 `loop`）或者重新开始（如果是 `loop`）
- `br` 指令的伪代码如下
  ```
  label: { // block|if
    // 参数应该在栈顶
    // 执行
    break label // 妥善处理操作数栈，保证参数被结果取代
    // 其他
  }

  label: { // loop
    // 参数应该在栈顶
    // ... 执行
    continue label // 妥善处理操作数栈，保证老的参数被新的参数取代
    // ... 其他指令
  }
  ```

### br_if 指令
- `br_if` 指令进行条件跳转
- 指令执行时，要先从操作数栈顶弹出一个布尔值（`i32` 类型）。如果该值为真（非零），则接着执行和 `br` 指令完全一样的逻辑，否则只相当于一次 `drop` 操作


### br_table 指令
- `br_table` 指令的立即数给定了 `n+1` 个跳转标签索引，其中前 `n` 个标签索引构成一个索引表，最后一个标签索引是默认索引
- `br_table` 指令执行时，要先从操作数栈顶弹出一个 `i32` 类型的值（记为 `m`）
  - `m<=n` 时，跳转到索引表第 `m` 个索引指向的标签处
  - 否则跳转到默认索引指定的标签处

### return 指令
- `return` 指令直接跳出最外层的块，导致函数直接返回

### unreachable 和 nop 指令
- `unreachable` 指令（操作码 0x00）引发一个运行时错误
- `nop` 指令（操作码 0x01）什么都不做
